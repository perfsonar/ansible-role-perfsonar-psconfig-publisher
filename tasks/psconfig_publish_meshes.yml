---
# tasks file for perfsonar-psconfig-publisher

- name: Copy psconfig JSON mesh to publisher host
  tags: [ 'ps::config' ]
  copy:
    src: "{{ psconfig_mesh.mesh }}"
    dest: "{{ psconfig_mesh.remote_dir | default('/tmp') }}"

- name: Publish psconfig JSON mesh
  tags: [ 'ps::config' ]
  command: >
    psconfig publish
    {{ psconfig_mesh.remote_dir | default('/tmp') }}/{{ psconfig_mesh.mesh }}
  register: "psconfig_url"

- name: Alert psconfig agents on remote hosts
  tags: [ 'ps::config' ]
  command: >
    psconfig remote add 
    "{{ psconfig_url.stdout | regex_search( '\"(.*?)\"' ) }}"
  delegate_to: "{{ item }}"
  with_items: "{{ psconfig_mesh.remote_agents | default([])}}"
  when: psconfig_mesh.remote_configure_archives | default('False') != True

- name: Alert psconfig agents on remote hosts and configure archives
  tags: [ 'ps::config' ]
  command: >
    psconfig remote add --configure-archives
    "{{ psconfig_url.stdout | regex_search( '\"(.*?)\"' ) }}"
  delegate_to: "{{ item }}"
  with_items: "{{ psconfig_mesh.remote_agents | default([])}}"
  when: psconfig_mesh.remote_configure_archives | default('False') == True
